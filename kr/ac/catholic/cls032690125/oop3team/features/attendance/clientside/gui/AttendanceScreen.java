package kr.ac.catholic.cls032690125.oop3team.features.attendance.clientside.gui;

import kr.ac.catholic.cls032690125.oop3team.client.Client;
import kr.ac.catholic.cls032690125.oop3team.features.attendance.shared.*;
import kr.ac.catholic.cls032690125.oop3team.models.Attendance;
import kr.ac.catholic.cls032690125.oop3team.models.Chatroom;

import javax.swing.*;
import java.awt.*;
import java.time.format.DateTimeFormatter;
import java.util.List;

public class AttendanceScreen extends JFrame {
    private JPanel recordListPanel;
    private Client client;
    private Chatroom chatroom;

    public AttendanceScreen(JFrame parent, Client client, Chatroom chatroom) {
        this.client = client;
        this.chatroom = chatroom;

        setTitle("Ï∂úÌá¥Í∑º Í∏∞Î°ù");
        setSize(500, 600);
        setLocationRelativeTo(parent);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);

        JPanel mainPanel = new JPanel(new BorderLayout(10, 10));
        mainPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // ÏÉÅÎã® Ìå®ÎÑê (Label Ï†úÎ™©)
        JPanel topPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        topPanel.add(new JLabel("ÏµúÍ∑º Í∏∞Î°ù Î≥¥Í∏∞"));
        mainPanel.add(topPanel, BorderLayout.NORTH);

        // Ï§ëÏïô Ïä§ÌÅ¨Î°§ ÏòÅÏó≠ (Ï∂úÌá¥Í∑º Í∏∞Î°ù Î¶¨Ïä§Ìä∏)
        recordListPanel = new JPanel();
        recordListPanel.setLayout(new BoxLayout(recordListPanel, BoxLayout.Y_AXIS));
        JScrollPane scrollPane = new JScrollPane(recordListPanel);
        mainPanel.add(scrollPane, BorderLayout.CENTER);

        // ÌïòÎã® Î≤ÑÌäº Ìå®ÎÑê (Ï∂úÍ∑º / Ìá¥Í∑º / ÏàòÏ†ï ÏöîÏ≤≠)
        JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton checkInButton = new JButton("Ï∂úÍ∑º");
        JButton checkOutButton = new JButton("Ìá¥Í∑º");
        JButton editRequestButton = new JButton("Í∏∞Î°ù ÏàòÏ†ï ÏöîÏ≤≠");

        String currentUserId = client.getCurrentSession().getUserId();
//        String ownerId = chatroom.getOwnerId();
//        boolean isManager = currentUserId.equals(ownerId);

        boolean isOwner = chatroom.isManager(currentUserId);
        JButton viewEditRequestsButton = new JButton("ÏàòÏ†ï ÏöîÏ≤≠ Î™©Î°ù Î≥¥Í∏∞");
        if (isOwner) {
            bottomPanel.add(viewEditRequestsButton);
            viewEditRequestsButton.addActionListener(e -> {
                new AttendanceEditRequestManageScreen(this, client).setVisible(true);
            });
        }

        // Ï∂úÍ∑º Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        checkInButton.addActionListener(e -> {
//            String userId = client.getCurrentSession().getUserId();
            int chatroomId = chatroom.getChatroomId();
            CCheckInRequest packet = new CCheckInRequest(currentUserId, chatroomId);

            client.request(packet, response -> {
                if (response instanceof SCheckInResponse checkInResponse) {
                    if (checkInResponse.isSuccess()) {
                        SwingUtilities.invokeLater(() -> {
                            JOptionPane.showMessageDialog(this, "Ï∂úÍ∑ºÏù¥ Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.");
                            updateRecordList();
                        });
                    } else {
                        SwingUtilities.invokeLater(() ->
                                JOptionPane.showMessageDialog(this, "Ï∂úÍ∑º Ïã§Ìå®: " + checkInResponse.getMessage()));
                    }
                }
            });
        });

        // Ìá¥Í∑º Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        checkOutButton.addActionListener(e -> {
            String userId = client.getCurrentSession().getUserId();
            int chatroomId = chatroom.getChatroomId();
            CCheckOutRequest packet = new CCheckOutRequest(currentUserId, chatroomId);

            client.request(packet, response -> {
                if (response instanceof SCheckOutResponse checkOutResponse) {
                    if (checkOutResponse.isSuccess()) {
                        SwingUtilities.invokeLater(() -> {
                            JOptionPane.showMessageDialog(this, "Ìá¥Í∑ºÏù¥ Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.");
                            updateRecordList();
                        });
                    } else {
                        SwingUtilities.invokeLater(() ->
                                JOptionPane.showMessageDialog(this, "Ìá¥Í∑º Ïã§Ìå®: " + checkOutResponse.getMessage()));
                    }
                }
            });
        });

        // Í∏∞Î°ù ÏàòÏ†ï ÏöîÏ≤≠ ÌôîÎ©¥ Ïó¥Í∏∞
        editRequestButton.addActionListener(e -> {
            new AttendanceEditScreen(this, client).setVisible(true);
        });

        bottomPanel.add(checkInButton);
        bottomPanel.add(checkOutButton);
        bottomPanel.add(editRequestButton);
        mainPanel.add(bottomPanel, BorderLayout.SOUTH);

        add(mainPanel);

        // ÏµúÏ¥à Î°úÎî© Ïãú Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞
        updateRecordList();

        System.out.println("ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†Ä ID: " + client.getCurrentSession().getUserId());
        System.out.println("Ï±ÑÌåÖÎ∞© ownerId: " + chatroom.getOwnerId());
        System.out.println("isManager: " + chatroom.isManager(client.getCurrentSession().getUserId()));

    }

    // Ï∂úÌá¥Í∑º Í∏∞Î°ù Î™©Î°ùÏùÑ ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏïÑÏôÄÏÑú Í∞±Ïã†
    private void updateRecordList() {
        int chatroomId = chatroom.getChatroomId();
        client.request(new CGetAttendanceListRequest(chatroomId), response -> {
            if (response instanceof SGetAttendanceListResponse res && res.isSuccess()) {
                List<Attendance> records = res.getRecords();
                if (records == null) records = List.of();

                final List<Attendance> finalRecords = records;

                SwingUtilities.invokeLater(() -> {
                    try {
                        recordListPanel.removeAll();
                        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

                        if (finalRecords.isEmpty()) {
                            recordListPanel.add(new JLabel("Ï∂úÌá¥Í∑º Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§."));
                        } else {
                            for (Attendance record : finalRecords) {
                                JPanel card = new JPanel(new BorderLayout(5, 5));
                                card.setBorder(BorderFactory.createLineBorder(Color.LIGHT_GRAY));
                                card.setBackground(Color.WHITE);
                                card.setMaximumSize(new Dimension(Integer.MAX_VALUE, 110));

                                JPanel info = new JPanel(new GridBagLayout());
                                GridBagConstraints gbc = new GridBagConstraints();

                                gbc.fill = GridBagConstraints.HORIZONTAL;
                                gbc.weightx = 1.0;
                                gbc.insets = new Insets(5, 20, 5, 20); // Padding

                                //time format
                                String dateStr = record.getCheckInTime() != null ?
                                        record.getCheckInTime().toLocalDateTime().format(formatter) : "Ï†ïÎ≥¥ ÏóÜÏùå";
                                String checkInStr = record.getCheckInTime() != null ?
                                        record.getCheckInTime().toLocalDateTime().format(formatter) : "";
                                String checkOutStr = record.getCheckOutTime() != null ?
                                        record.getCheckOutTime().toLocalDateTime().format(formatter) : "";

                                int totalMin = record.getWorkTimeTotal();
                                String workTime = (totalMin / 60 > 0 ? (totalMin / 60) + "ÏãúÍ∞Ñ " : "") + (totalMin % 60) + "Î∂Ñ";

                                // ÏÇ¨Ïö©Ïûê: username (centered)
                                JLabel nameLabel = new JLabel("ÏÇ¨Ïö©Ïûê: " + record.getUsername()+" Îãò");
                                nameLabel.setFont(new Font("SansSerif", Font.BOLD, 20));
                                nameLabel.setForeground(new Color(0, 102, 204)); // Xanh d∆∞∆°ng ƒë·∫≠m

                                gbc.gridx = 0;
                                gbc.gridy = 0;
                                gbc.gridwidth = 2;
                                gbc.anchor = GridBagConstraints.CENTER;
                                info.add(nameLabel, gbc);


                                // ÎÇ†Ïßú (left)
                                gbc.gridx = 0;
                                gbc.gridy = 1;
                                gbc.gridwidth = 1;
                                gbc.anchor = GridBagConstraints.WEST;
                                info.add(new JLabel("üìÖ ÎÇ†Ïßú: " + dateStr), gbc);

                                // Ï∂úÍ∑º (right)
                                gbc.gridx = 1;
                                gbc.gridy = 1;
                                gbc.anchor = GridBagConstraints.EAST;
                                info.add(new JLabel("üïò Ï∂úÍ∑º: " + checkInStr), gbc);

                                // Ìá¥Í∑º (left)
                                gbc.gridx = 0;
                                gbc.gridy = 2;
                                gbc.anchor = GridBagConstraints.WEST;
                                info.add(new JLabel("üïî Ìá¥Í∑º: " + checkOutStr), gbc);

                                // Ï¥ù Í∑ºÎ¨¥ (right)
                                gbc.gridx = 1;
                                gbc.gridy = 2;
                                gbc.anchor = GridBagConstraints.EAST;
                                info.add(new JLabel("‚è±Ô∏è Ï¥ù Í∑ºÎ¨¥: " + workTime), gbc);

                                card.add(info, BorderLayout.CENTER);
                                recordListPanel.add(card);
                                recordListPanel.add(Box.createVerticalStrut(10));
                            }
                        }

                        recordListPanel.revalidate();
                        recordListPanel.repaint();
                    } catch (Exception ex) {
                        ex.printStackTrace();
                        JOptionPane.showMessageDialog(this, "Í∏∞Î°ù ÌëúÏãú Ïò§Î•ò: " + ex.getMessage());
                    }
                });

            } else {
                SwingUtilities.invokeLater(() -> {
                    String msg = (response instanceof SGetAttendanceListResponse res) ? res.getMessage() : "ÏùëÎãµ ÏóÜÏùå";
                    JOptionPane.showMessageDialog(this, "Ï°∞Ìöå Ïã§Ìå®: " + msg);
                });
            }
        });
    }

}
